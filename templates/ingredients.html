<div class="row">
    <div class="col-lg-12">
        <div>
            <ul class="nav nav-tabs" role="tablist">
                <for each="category">
                    <li role="presentation" class="{{_idx == 0 ? 'active' : ''}}"><a href="#{{_id}}"
                            aria-controls="{{_id}}" role="tab" data-toggle="tab">{{name}}</a></li>
                </for>
                <li role="presentation">
                    <a href="#add-category" role="tab" aria-controls="add-category" data-toggle="tab">
                        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                    </a>
                </li>
            </ul>
            <div class="l-picker">
                [[letterPicker]]
            </div>
            <div class="tab-content">
                <for each="category">
                    <div role="tabpanel" class="tab-pane {{_idx == 0 ? 'active' : 'nan'}}" id="{{_id}}">
                        <div class="well">
                            <ul class="list-group"></ul>
                            <div id="no-results-{{_id}}" class="d-none">
                                <div class="add-new-result">
                                    No matches
                                </div>
                            </div>
                        </div>
                    </div>
                </for>
                <div role="tabpanel" class="tab-pane" id="add-category">
                    <div class="input-group" id="add-category-group">
                        <input type="text" class="form-control" placeholder="New category">
                        <span class="input-group-btn">
                            <button class="btn btn-default" type="button">Add</button>
                        </span>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(() => {

        const $searchResults = $('#search-results');
        const $addNewResult = $('.add-new-result');
        const $addCategoryGroup = $('#add-category-group');
        const $selectedCategory = $('#selected-category');

        function createListGroupItem(name) {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.textContent = name;
            return li
        }

        let currentResults = [];
        let selectedCategory = 'all'
        let selectedLetter = '';

        function rebuildPanel() {
            const $panel = $($(`[role=tabpanel]#${selectedCategory}`)[0]);
            const ul = $panel.find('ul')
            $(ul).empty();

            const $noResults = $panel.find('#no-results-' + selectedCategory)

            if (currentResults.length === 0) {
                $noResults.removeClass('d-none')
            } else {
                $noResults.addClass('d-none')
            }

            currentResults.forEach(result => {
                const li = createListGroupItem(result.name);
                li.addEventListener('click', e => {
                    const ev = new CustomEvent('yr.ingredient', { detail: result })
                    document.dispatchEvent(ev)
                })
                ul.append(li)
            })
        }

        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            selectedCategory = e.target.getAttribute('aria-controls');
            search('^' + selectedLetter)
                .then(results => setResults(results))
                .catch(err => console.error(err));
        })

        function search(text) {
            return new Promise((resolve, reject) => {
                let query = 'sw=' + text;
                if (selectedCategory !== 'all') {
                    query += '&category=' + selectedCategory;
                }
                $.get('/api/ingredient?' + query)
                    .then((data, status) => {
                        resolve(data);
                    }, err => reject(err))
            })
        }

        function setResults(results) {
            $searchResults.empty();
            currentResults = results;
            rebuildPanel();
        }

        $addNewResult.click(() => {
            const ingredient = $ingredientInput.val();
            if (!ingredient) {
                console.error('no ingredient')
                return;
            }
            if (selectedCategory === 'all') {
                console.error('cannot do all yet')
                return;
            }
            $.post('/api/ingredient', JSON.stringify({ name: ingredient, category: selectedCategory }))
                .then((data, status) => {
                    search(ingredient)
                        .then(results => setResults(results))
                        .catch(err => console.error(err));
                }, err => console.error(err))
        });

        $addCategoryGroup.find('.btn')
            .click(() => {
                const name = $addCategoryGroup.find('input').val();
                if (!!name) {
                    PromiseHttp.post('/api/category', JSON.stringify({ name }))
                        .then(_ => window.location = window.location)
                        .catch(err => console.error(err));
                }
            })

        search('')
            .then(results => setResults(results))
            .catch(err => console.error(err));

        const $lpicker = $('.l-picker')
        $lpicker.on('letter-clicked', function (e) {
            let letter = e.letter
            if (e.letter === selectedLetter) {
                $lpicker.find(`[letter="${selectedLetter}"]`).removeClass('btn-info')
                selectedLetter = '';
                letter = '';
            } else {
                $lpicker.find(`[letter="${selectedLetter}"]`).removeClass('btn-info')
                selectedLetter = letter;
                $lpicker.find(`[letter="${selectedLetter}"]`).addClass('btn-info')
            }
            search('^' + letter)
                .then(results => setResults(results))
                .catch(err => console.error(err));
        })
    })
</script>